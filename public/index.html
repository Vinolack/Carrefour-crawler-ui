<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrefour çˆ¬è™«æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .progress { height: 25px; }
        #logArea { background: #212529; color: #00ff00; font-family: monospace; height: 150px; overflow-y: auto; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="text-center mb-4">
                <h2 class="text-primary fw-bold">ğŸ›’ Carrefour çˆ¬è™«æ§åˆ¶å°</h2>
                <p class="text-muted">ä¸Šä¼ åŒ…å« URL çš„ Excel æ–‡ä»¶å³å¯å¼€å§‹é‡‡é›†</p>
            </div>

            <div class="card p-4 mb-4">
                <form id="taskForm">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="fileInput" class="form-label fw-bold m-0">1. ä¸Šä¼  Excel æ–‡ä»¶ (.xlsx)</label>
                            <a href="/api/template" class="btn btn-sm btn-outline-secondary" target="_blank">
                                ğŸ“¥ ä¸‹è½½ç¤ºä¾‹æ¨¡æ¿
                            </a>
                        </div>
                        <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls" required>
                        <div class="form-text">è¯·ç¡®ä¿ç¬¬ä¸€åˆ—åŒ…å«éœ€è¦çˆ¬å–çš„ URLï¼ˆæ”¯æŒå¸¦æ ‡é¢˜è¡Œï¼‰ã€‚</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskType" class="form-label fw-bold">2. é€‰æ‹©ä»»åŠ¡ç±»å‹</label>
                            <select class="form-select" id="taskType">
                                <option value="product">Product (å®Œæ•´è¯¦æƒ…)</option>
                                <option value="repricing">Repricing (æ”¹ä»·ç›‘æ§)</option>
                                <option value="listing_price">Listing Price (ä¸Šæ¶æ¯”ä»·)</option>
                                <option value="store">Store (åº—é“ºéå†)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="pages" class="form-label fw-bold">çˆ¬å–é¡µæ•° (ä»… Store æœ‰æ•ˆ)</label>
                            <input type="number" class="form-control" id="pages" value="1" min="1">
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">å¼€å§‹çˆ¬å–ä»»åŠ¡</button>
                    </div>
                </form>
            </div>

            <div id="progressPanel" class="card p-4 d-none">
                <h4 class="card-title">ä»»åŠ¡è¿›åº¦</h4>
                <div class="mb-2 d-flex justify-content-between">
                    <span id="statusText" class="badge bg-warning text-dark">åˆå§‹åŒ–ä¸­...</span>
                    <span id="counterText">0 / 0</span>
                </div>
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header py-1 text-white bg-dark">å®æ—¶æ—¥å¿—/çŠ¶æ€</div>
                    <div class="card-body p-2" id="logArea">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
                </div>

                <div class="d-grid">
                    <button id="downloadBtn" class="btn btn-success btn-lg disabled">ğŸ“¥ ä¸‹è½½ç»“æœ Excel</button>
                    <a id="downloadLink" style="display:none"></a>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const form = document.getElementById('taskForm');
    const submitBtn = document.getElementById('submitBtn');
    const progressPanel = document.getElementById('progressPanel');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const counterText = document.getElementById('counterText');
    const logArea = document.getElementById('logArea');
    const downloadBtn = document.getElementById('downloadBtn');
    
    let currentTaskId = null;
    let pollInterval = null;

    // æ·»åŠ æ—¥å¿—è¾…åŠ©å‡½æ•°
    function addLog(msg) {
        const time = new Date().toLocaleTimeString();
        logArea.innerHTML += `<div>[${time}] ${msg}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileInput');
        if(fileInput.files.length === 0) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

        // å‡†å¤‡ä¸Šä¼ 
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('type', document.getElementById('taskType').value);
        formData.append('pages', document.getElementById('pages').value);

        // UI çŠ¶æ€åˆ‡æ¢
        submitBtn.disabled = true;
        submitBtn.textContent = "æäº¤ä¸­...";
        progressPanel.classList.remove('d-none');
        logArea.innerHTML = '';
        addLog('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶å¹¶è§£æ...');
        
        try {
            const res = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                currentTaskId = data.task_id;
                addLog(`ä»»åŠ¡åˆ›å»ºæˆåŠŸ! ID: ${currentTaskId}`);
                addLog(`æœåŠ¡ç«¯æ¶ˆæ¯: ${data.message}`);
                startPolling();
            } else {
                addLog(`é”™è¯¯: ${data.error}`);
                submitBtn.disabled = false;
                submitBtn.textContent = "å¼€å§‹çˆ¬å–ä»»åŠ¡";
            }
        } catch (err) {
            addLog(`ç½‘ç»œé”™è¯¯: ${err.message}`);
            submitBtn.disabled = false;
        }
    });

    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        
        pollInterval = setInterval(async () => {
            try {
                const res = await fetch(`/api/status/${currentTaskId}`);
                const data = await res.json();
                
                updateUI(data);

                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval);
                    finishTask(data);
                }
            } catch (err) {
                console.error("è½®è¯¢é”™è¯¯", err);
            }
        }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
    }

    function updateUI(data) {
        // æ›´æ–°çŠ¶æ€æ ‡ç­¾
        statusText.textContent = data.status.toUpperCase();
        if (data.status === 'scraping_products') {
            statusText.className = 'badge bg-primary';
        } else if (data.status === 'completed') {
            statusText.className = 'badge bg-success';
        } else if (data.status === 'failed') {
            statusText.className = 'badge bg-danger';
        }

        // æ›´æ–°è®¡æ•°å™¨
        const processed = data.processed || 0;
        const total = data.total || 0;
        counterText.textContent = `${processed} / ${total}`;

        // æ›´æ–°è¿›åº¦æ¡
        let percentage = 0;
        if (total > 0) {
            percentage = Math.round((processed / total) * 100);
        }
        // å¦‚æœæ˜¯ store æ‰«æé˜¶æ®µä¸” total è¿˜æ˜¯0ï¼Œç»™ä¸ªå‡åŠ¨ç”»
        if (data.status === 'scanning_pages' && total === 0) {
            progressBar.classList.add('progress-bar-striped');
            progressBar.style.width = '100%';
            progressBar.textContent = 'æ‰«æé“¾æ¥ä¸­...';
        } else {
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }

        // æ›´æ–°æ—¥å¿— (å¦‚æœ progress æ–‡æœ¬æœ‰å˜åŒ–)
        if (data.progress && logArea.lastElementChild?.textContent.indexOf(data.progress) === -1) {
             addLog(data.progress);
        }
    }

    function finishTask(data) {
        submitBtn.disabled = false;
        submitBtn.textContent = "å¼€å§‹æ–°ä»»åŠ¡";

        if (data.status === 'completed') {
            addLog(`ä»»åŠ¡å®Œæˆï¼å…±è·å– ${data.results_count} æ¡æ•°æ®ã€‚`);
            downloadBtn.classList.remove('disabled');
            downloadBtn.onclick = () => {
                window.location.href = `/api/download/${currentTaskId}`;
            };
        } else {
            addLog('ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Python åå°æ—¥å¿—ã€‚');
        }
    }
</script>

</body>
</html>